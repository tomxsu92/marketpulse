name: Daily Market Intelligence Update

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Fetch market data
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python scripts/fetch_data.py
        continue-on-error: true
      
      - name: Generate content
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python scripts/generate_content.py
        continue-on-error: true
      
      - name: Commit generated content
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ data/
          git diff --staged --quiet || (git commit -m "Add daily content [automated]" && git push)
      
      - name: Build professional site
        run: |
          mkdir -p public/tools public/comparisons
          
          # Create main index with professional design
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MarketPulse AI - B2B SaaS Intelligence</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                line-height: 1.6; 
                color: #333;
                background: #f8f9fa;
              }
              .container { max-width: 900px; margin: 0 auto; padding: 20px; }
              header { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 60px 20px;
                text-align: center;
                margin-bottom: 40px;
              }
              header h1 { font-size: 3em; margin-bottom: 10px; font-weight: 700; }
              header p { font-size: 1.3em; opacity: 0.9; }
              nav { 
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-bottom: 30px;
                text-align: center;
              }
              nav a { 
                margin: 0 20px;
                text-decoration: none;
                color: #667eea;
                font-weight: 600;
                font-size: 1.1em;
              }
              nav a:hover { color: #764ba2; }
              .article { 
                background: white;
                margin: 20px 0;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: transform 0.2s;
              }
              .article:hover { transform: translateY(-2px); }
              .article h3 { 
                margin-bottom: 10px;
                font-size: 1.5em;
              }
              .article h3 a { 
                color: #333;
                text-decoration: none;
              }
              .article h3 a:hover { color: #667eea; }
              .date { 
                color: #666;
                font-size: 0.9em;
                margin-bottom: 15px;
              }
              .badge {
                display: inline-block;
                background: #667eea;
                color: white;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 0.75em;
                font-weight: 600;
                margin-right: 10px;
                text-transform: uppercase;
              }
              .excerpt {
                color: #666;
                margin-top: 10px;
              }
              .disclaimer { 
                margin-top: 50px;
                padding: 20px;
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                font-size: 0.9em;
                border-radius: 0 8px 8px 0;
              }
              footer {
                text-align: center;
                padding: 40px;
                color: #666;
                margin-top: 50px;
              }
              .stats {
                display: flex;
                justify-content: center;
                gap: 40px;
                margin: 30px 0;
                flex-wrap: wrap;
              }
              .stat {
                text-align: center;
              }
              .stat-number {
                font-size: 2em;
                font-weight: bold;
                color: #667eea;
              }
              .stat-label {
                color: #666;
                font-size: 0.9em;
              }
            </style>
          </head>
          <body>
            <header>
              <h1>MarketPulse AI</h1>
              <p>Automated market intelligence for B2B software buyers</p>
            </header>
            
            <div class="container">
              <nav>
                <a href="./index.html">Home</a>
                <a href="./tools/index.html">Tool Reviews</a>
                <a href="./comparisons/index.html">Comparisons</a>
              </nav>
              
              <div class="stats">
                <div class="stat">
                  <div class="stat-number">15+</div>
                  <div class="stat-label">Tools Analyzed</div>
                </div>
                <div class="stat">
                  <div class="stat-number">Daily</div>
                  <div class="stat-label">Fresh Content</div>
                </div>
                <div class="stat">
                  <div class="stat-number">100%</div>
                  <div class="stat-label">Data-Driven</div>
                </div>
              </div>
              
              <h2 style="margin-bottom: 20px; color: #333;">Latest Reviews</h2>
          EOF
          
          # Count total articles
          article_count=0
          
          # Add articles with category badges
          for f in content/tools/*.md; do
            if [ -f "$f" ] && [ "$(basename "$f")" != "_index.md" ]; then
              title=$(grep "^title:" "$f" | head -1 | sed 's/title: //' | sed 's/"//g')
              date=$(grep "^date:" "$f" | head -1 | sed 's/date: //' | sed 's/"//g' | cut -d'T' -f1)
              category=$(grep "^category:" "$f" | head -1 | sed 's/category: //' | sed 's/"//g')
              filename=$(basename "$f" .md)
              
              echo "<div class='article'>
                <span class='badge'>$category</span>
                <h3><a href='tools/$filename.html'>$title</a></h3>
                <div class='date'>Published: $date</div>
                <p class='excerpt'>Comprehensive review including pricing analysis, feature breakdown, and alternative recommendations.</p>
              </div>" >> public/index.html
              
              # Create styled individual page
              cat > "public/tools/$filename.html" << HTMLSTART
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>$title</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                line-height: 1.6; 
                color: #333;
                background: #f8f9fa;
              }
              .container { max-width: 800px; margin: 0 auto; padding: 20px; background: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
              .nav { 
                padding: 20px 0;
                margin-bottom: 30px;
                border-bottom: 2px solid #667eea;
              }
              .nav a { 
                margin-right: 20px;
                text-decoration: none;
                color: #667eea;
                font-weight: 600;
              }
              .nav a:hover { color: #764ba2; }
              h1 { color: #333; margin-bottom: 20px; font-size: 2.5em; line-height: 1.2; }
              h2 { color: #667eea; margin-top: 40px; margin-bottom: 15px; font-size: 1.8em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
              h3 { color: #555; margin-top: 25px; margin-bottom: 10px; }
              p { margin-bottom: 15px; font-size: 1.1em; }
              strong { color: #667eea; }
              ul, ol { margin-bottom: 20px; padding-left: 30px; }
              li { margin-bottom: 8px; }
              .disclaimer { 
                margin-top: 50px;
                padding: 20px;
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                font-size: 0.9em;
                border-radius: 0 8px 8px 0;
              }
              .cta-box {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                border-radius: 8px;
                margin: 30px 0;
                text-align: center;
              }
              .cta-box a {
                color: white;
                text-decoration: underline;
                font-weight: bold;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="nav">
                <a href="../index.html">← Home</a>
                <a href="./index.html">All Reviews</a>
              </div>
          HTMLSTART
              
              # Convert markdown content (skip frontmatter - first 20 lines)
              tail -n +20 "$f" | sed 's/^# /<h1>/' | sed 's/^## /<h2>/' | sed 's/^### /<h3>/' | sed 's/\*\*/<strong>/g' | sed 's/\*\*/<\/strong>/g' >> "public/tools/$filename.html"
              
              cat >> "public/tools/$filename.html" << 'HTMLEND'
              <div class="disclaimer">
                <strong>Disclosure:</strong> This review contains affiliate links. We may earn a commission at no extra cost to you.
              </div>
            </div>
          </body>
          </html>
          HTMLEND
              
              article_count=$((article_count + 1))
            fi
          done
          
          # Close container and add footer
          echo "<div class='disclaimer'>
            <strong>Disclosure:</strong> This site contains affiliate links. We may earn a commission when you purchase through our links, at no extra cost to you.
          </div>
          
          <footer>
            <p>&copy; 2024 MarketPulse AI. Automated market intelligence.</p>
            <p style='font-size: 0.8em; margin-top: 10px;'>$article_count reviews and counting</p>
          </footer>
          </div></body></html>" >> public/index.html
          
          # Create styled tools listing page
          cat > public/tools/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Tool Reviews - MarketPulse AI</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                line-height: 1.6; 
                color: #333;
                background: #f8f9fa;
              }
              .container { max-width: 900px; margin: 0 auto; padding: 20px; }
              header { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px 20px;
                text-align: center;
                margin-bottom: 30px;
              }
              header h1 { font-size: 2.5em; margin-bottom: 10px; }
              nav { 
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-bottom: 30px;
                text-align: center;
              }
              nav a { 
                margin: 0 20px;
                text-decoration: none;
                color: #667eea;
                font-weight: 600;
              }
              .article { 
                background: white;
                margin: 15px 0;
                padding: 25px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              }
              .article h3 { margin-bottom: 8px; }
              .article h3 a { color: #333; text-decoration: none; }
              .article h3 a:hover { color: #667eea; }
              .badge {
                display: inline-block;
                background: #667eea;
                color: white;
                padding: 3px 10px;
                border-radius: 20px;
                font-size: 0.7em;
                font-weight: 600;
                margin-right: 10px;
                text-transform: uppercase;
              }
              .disclaimer { 
                margin-top: 40px;
                padding: 20px;
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                font-size: 0.9em;
              }
            </style>
          </head>
          <body>
            <header>
              <h1>Tool Reviews</h1>
              <p>Comprehensive software analysis</p>
            </header>
            
            <div class="container">
              <nav>
                <a href="../index.html">← Home</a>
                <a href="../comparisons/index.html">Comparisons</a>
              </nav>
              
              <h2 style="margin-bottom: 20px;">All Reviews</h2>
          EOF
          
          for f in content/tools/*.md; do
            if [ -f "$f" ] && [ "$(basename "$f")" != "_index.md" ]; then
              title=$(grep "^title:" "$f" | head -1 | sed 's/title: //' | sed 's/"//g')
              category=$(grep "^category:" "$f" | head -1 | sed 's/category: //' | sed 's/"//g')
              filename=$(basename "$f" .md)
              echo "<div class='article'>
                <span class='badge'>$category</span>
                <h3><a href='$filename.html'>$title</a></h3>
              </div>" >> public/tools/index.html
            fi
          done
          
          echo "<div class='disclaimer'>
            <strong>Disclosure:</strong> This site contains affiliate links. We may earn a commission when you purchase through our links, at no extra cost to you.
          </div>
          </div></body></html>" >> public/tools/index.html
          
          # Create styled comparisons listing page
          cat > public/comparisons/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Comparisons - MarketPulse AI</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                line-height: 1.6; 
                color: #333;
                background: #f8f9fa;
              }
              .container { max-width: 900px; margin: 0 auto; padding: 20px; }
              header { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px 20px;
                text-align: center;
                margin-bottom: 30px;
              }
              header h1 { font-size: 2.5em; margin-bottom: 10px; }
              nav { 
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-bottom: 30px;
                text-align: center;
              }
              nav a { 
                margin: 0 20px;
                text-decoration: none;
                color: #667eea;
                font-weight: 600;
              }
              .article { 
                background: white;
                margin: 15px 0;
                padding: 25px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              }
              .article h3 { margin-bottom: 8px; }
              .article h3 a { color: #333; text-decoration: none; }
              .article h3 a:hover { color: #667eea; }
              .vs-badge {
                display: inline-block;
                background: #764ba2;
                color: white;
                padding: 3px 10px;
                border-radius: 20px;
                font-size: 0.7em;
                font-weight: 600;
                margin-right: 10px;
              }
              .disclaimer { 
                margin-top: 40px;
                padding: 20px;
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                font-size: 0.9em;
              }
            </style>
          </head>
          <body>
            <header>
              <h1>Comparisons</h1>
              <p>Side-by-side software analysis</p>
            </header>
            
            <div class="container">
              <nav>
                <a href="../index.html">← Home</a>
                <a href="../tools/index.html">Tool Reviews</a>
              </nav>
              
              <h2 style="margin-bottom: 20px;">Head-to-Head Comparisons</h2>
          EOF
          
          for f in content/comparisons/*.md; do
            if [ -f "$f" ] && [ "$(basename "$f")" != "_index.md" ]; then
              title=$(grep "^title:" "$f" | head -1 | sed 's/title: //' | sed 's/"//g')
              filename=$(basename "$f" .md)
              echo "<div class='article'>
                <span class='vs-badge'>VS</span>
                <h3><a href='$filename.html'>$title</a></h3>
              </div>" >> public/comparisons/index.html
            fi
          done
          
          echo "<div class='disclaimer'>
            <strong>Disclosure:</strong> This site contains affiliate links. We may earn a commission when you purchase through our links, at no extra cost to you.
          </div>
          </div></body></html>" >> public/comparisons/index.html
          
          echo "Professional site built with $article_count articles"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Health check
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: python scripts/health_check.py
        continue-on-error: true
