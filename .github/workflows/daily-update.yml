name: Daily Market Intelligence Update

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Fetch market data
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python scripts/fetch_data.py
        continue-on-error: true
      
      - name: Generate content
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python scripts/generate_content.py
        continue-on-error: true
      
      - name: Commit and push content
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/ data/
          git diff --staged --quiet || (git commit -m "Add daily content [automated]" && git push)
      
      - name: Build site
        run: |
          mkdir -p public/tools public/comparisons
          
          # Create main index
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>MarketPulse AI - B2B SaaS Intelligence</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; line-height: 1.6; }
              h1 { color: #333; border-bottom: 2px solid #0066cc; padding-bottom: 10px; }
              .nav { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
              .nav a { margin-right: 20px; text-decoration: none; color: #0066cc; font-weight: bold; }
              .article { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
              .article h3 { margin-top: 0; color: #0066cc; }
              .date { color: #666; font-size: 14px; }
              .disclaimer { margin-top: 30px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; font-size: 14px; }
            </style>
          </head>
          <body>
            <h1>MarketPulse AI</h1>
            <p style="font-size: 18px; color: #555;">Automated market intelligence for B2B software buyers</p>
            
            <div class="nav">
              <a href="/marketpulse-ai/">Home</a>
              <a href="/marketpulse-ai/tools/">Tool Reviews</a>
              <a href="/marketpulse-ai/comparisons/">Comparisons</a>
            </div>
            
            <h2>Latest Reviews</h2>
          EOF
          
          # Add links to generated content
          for f in content/tools/*.md; do
            if [ -f "$f" ]; then
              title=$(grep "^title:" "$f" | head -1 | sed 's/title: //' | sed 's/"//g')
              date=$(grep "^date:" "$f" | head -1 | sed 's/date: //' | sed 's/"//g' | cut -d'T' -f1)
              filename=$(basename "$f" .md)
              echo "<div class='article'><h3><a href='tools/$filename.html'>$title</a></h3><p class='date'>Published: $date</p></div>" >> public/index.html
              
              # Convert markdown to HTML (basic conversion)
              cat > "public/tools/$filename.html" << 'HTMLSTART'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Review</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; line-height: 1.6; }
              h1 { color: #333; border-bottom: 2px solid #0066cc; }
              h2 { color: #555; margin-top: 30px; }
              .nav { margin: 20px 0; padding: 10px; background: #f5f5f5; }
              .nav a { margin-right: 20px; text-decoration: none; color: #0066cc; }
              .content { margin: 30px 0; }
              .disclaimer { margin-top: 30px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; font-size: 14px; }
            </style>
          </head>
          <body>
            <div class="nav">
              <a href="/marketpulse-ai/">‚Üê Home</a>
            </div>
            <div class="content">
          HTMLSTART
              
              # Convert markdown content (skip frontmatter)
              tail -n +20 "$f" | sed 's/^# /<h1>/' | sed 's/^## /<h2>/' | sed 's/^### /<h3>/' | sed 's/\*\*/<strong>/g' | sed 's/\*\*/<\/strong>/g' >> "public/tools/$filename.html"
              
              cat >> "public/tools/$filename.html" << 'HTMLEND'
            </div>
            <div class="disclaimer">
              <strong>Disclosure:</strong> This review contains affiliate links. We may earn a commission at no extra cost to you.
            </div>
          </body>
          </html>
          HTMLEND
            fi
          done
          
          # Close main index
          echo "<div class='disclaimer'><strong>Disclosure:</strong> This site contains affiliate links. We may earn a commission when you purchase through our links, at no extra cost to you.</div>" >> public/index.html
          echo "</body></html>" >> public/index.html
          
          echo "Site built successfully"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Health check
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: python scripts/health_check.py
        continue-on-error: true
